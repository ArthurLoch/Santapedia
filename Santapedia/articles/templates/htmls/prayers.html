{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block 'title' %}{% trans 'Orações' %}{% endblock %}

{% block 'css'%}
    <link rel="stylesheet" href="{% static 'css/home.css' %}">
    <link rel="stylesheet" href="{% static 'css/prayers.css' %}">
{% endblock %}

{% block 'body' %}

<!-- Filter button -->
<button id="filter">{% trans 'Filtrar pesquisa' %} <i class="bi bi-funnel"></i></button>

<!-- Menu filter -->
<div id="menu-filter">
    <form method="get" class="filters">

        <!-- Order filter -->
        <select name="order">
            <option disabled value="" {% if not request.GET.order %}selected{% endif %}>{% trans 'Ordenar por' %}</option>
            <option value="latest" {% if request.GET.order == 'latest' %}selected{% endif %}>{% trans 'Mais recentes' %}</option>
            <option value="oldest" {% if request.GET.order == 'oldest' %}selected{% endif %}>{% trans 'Mais antigos' %}</option>
            <option value="name" {% if request.GET.order == 'name' %}selected{% endif %}>{% trans 'Nome' %} (A–Z)</option>
        </select>
    
        <!-- Category filter -->
        <select name="category">
            <option disabled value="" {% if not request.GET.category %}selected{% endif %}>{% trans 'Categoria' %}</option>
            {% for category in categories %}
                <option value="{{category}}" {% if request.GET.category == category %}selected{% endif %}>{{category}}</option>
            {% endfor %}
        </select>

        <!-- Saint filter -->
        <select name="saint">
            <option disabled value="" {% if not request.GET.saint %}selected{% endif %}>{% trans 'Santo' %}</option>
            {% for saint in saints %}
                <option value="{{saint}}" {% if request.GET.saint == saint %}selected{% endif %}>{{saint}}</option>
            {% endfor %}
        </select>

        <!-- Prayer's name filter -->
        <input type="search" name="title" id="title" class="form-control" placeholder="{% trans 'Nome' %}" {% if request.GET.title %}value="{{request.GET.title}}"{% endif %} >

        <button type="submit" class="search">{% trans 'Filtrar' %}</button>

        <!-- Clean button -->
        <button type="button" class="clear-btn"><a href="{% url 'prayers' %}">{% trans 'Limpar' %}</a></button>
    </form>
</div>



<div class="container py-4">
    <h1>{% trans 'Orações' %} ({{ len_prayers }})</h1>

    {% for prayer in prayers %}
        <!-- Prayer card -->
        <article class="media" id="{{ prayer.title }}">
            <div class="body">
                {% if request.LANGUAGE_CODE == 'en' %}
                    <h2>{{ prayer.title_en }}</h2>
                {% else %}
                    <h2>{{ prayer.title_pt }}</h2>
                {% endif %}

                {% if prayer.saint %}
                    {% if request.LANGUAGE_CODE == 'en' %}
                        <p class="text-muted mb-1">{% trans 'Santo' %}: <strong>{{ prayer.saint.title_en }}</strong></p>
                    {% else %}
                        <p class="text-muted mb-1">{% trans 'Santo' %}: <strong>{{ prayer.saint.title_pt }}</strong></p>
                    {% endif %}
                {% endif %}

                {% if request.LANGUAGE_CODE == 'en' %}
                    <p class="prayer-text" id="text-{{ prayer.id }}">
                        {{ prayer.content_en|truncatechars_html:175|safe }}
                    </p>
                {% else %}
                    <p class="prayer-text" id="text-{{ prayer.id }}">
                        {{ prayer.content_pt|truncatechars_html:175|safe }}
                    </p>
                {% endif %}
                
                <!-- Read full prayer -->
                <button class="collapse-btn" type="button" data-id="{{ prayer.id }}" aria-expanded="false">
                    {% trans 'Ler oração completa' %}<i class="bi bi-chevron-down"></i>
                </button>
            </div>

            {% if prayer.saint and prayer.saint.image %}
                <img src="{{ prayer.saint.image.url }}" alt="Imagem de {{ prayer.saint.title }}">
            {% endif %}

            
        </article>
    {% empty %}
        <!-- Don't exist any prayer -->
        <p class="text-muted">{% trans 'Nenhuma oração cadastrada.' %}</p>
    {% endfor %}
</div>


<script>
    // Animation of appear and disappear the menu filter
    document.addEventListener('DOMContentLoaded', function() {

        var button_filter = document.getElementById("filter")
        var menu_filter = document.getElementById("menu-filter")

        button_filter.addEventListener('click', function() {
            if (menu_filter.style.display === '' || menu_filter.style.display === 'none') {
                menu_filter.style.display = 'block'
            } else {
                menu_filter.style.display = 'none'
            }
        })

    })
</script>

<script>
    // Show short and full version of a prayer
    const prayersData = {
    {% for prayer in prayers %}
        {% if request.LANGUAGE_CODE == 'en' %}
            "{{ prayer.id }}": {
                "short": `{{ prayer.content_en|truncatechars_html:400|escapejs }}`,
                "full": `{{ prayer.content_en|linebreaks|escapejs }}`
            },
        {% else %}
            "{{ prayer.id }}": {
                "short": `{{ prayer.content_pt|truncatechars_html:400|escapejs }}`,
                "full": `{{ prayer.content_pt|linebreaks|escapejs }}`
            },
        {% endif %}
    {% endfor %}
    };
</script>

<script src="{% static 'js/prayers.js' %}"></script>
    
{% endblock %}